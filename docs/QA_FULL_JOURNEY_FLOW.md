# זרימת הטסט E2E – QA Full Journey

**קובץ:** `tests/e2e/qa-full-journey.spec.ts`  
**סביבה:** https://archiflow-independent.vercel.app  
**עדכון:** 31/01/2026

---

## 1. מטרה והגדרות

| פריט | תיאור |
|------|--------|
| **מטרה** | בדיקה רציפה מקיפה (E2E) עם יצירת ישויות אמיתיות ובדיקת פונקציונליות לכל תפקיד |
| **הרצה** | `$env:PLAYWRIGHT_BASE_URL="https://archiflow-independent.vercel.app"; npm run test:e2e:full:headed` |
| **דוח** | מערך `report` – כל שלב מסומן ✅ / ❌ / ⚠️; בסוף מודפס סיכום ו־`expect(failed).toBe(0)` |
| **Helpers** | `dismissPopups` (סגירת "הישאר מעודכן"), `delay`, `safeCheck`, `waitAfterAction`, `runStepWithLog`, לוגינג קונסול/רשת |
| **Fail-fast** | ברירת מחדל: ברגע ששלב נכשל (❌) – הריצה **נעצרת**, מודפס מזהה + שם בדיקה + הערה. מתקנים את השגיאה ומריצים מחדש עד 100%. כיבוי: `QA_FAIL_FAST=0` להרצה מלאה. |

### לוג ריצה והמתנות

| פריט | תיאור |
|------|--------|
| **לוג ריצה** | `runLog` – רשימת פעולות עם מזהה, תוצאה (ok/fail/skip), משך (ms), פרטים. מאפשר לנתח כל ריצה ולשפר. |
| **כיבוי לוג** | `QA_RUN_LOG=0` – כיבוי לוג הריצה. |
| **ייצוא לקובץ** | `QA_RUN_LOG_FILE=path/to/run.json` – שמירת דוח + runLog ל־JSON בסוף הריצה. |
| **המתנה אחרי פעולה** | `waitAfterAction(page, ms)` – מחכה ל־networkidle ואז ל־delay; משמש אחרי ניווט, לחיצות וטעינת תוכן. |
| **בדיקה עם לוג** | `runStepWithLog(stepId, name, fn)` – מריץ את הבדיקה, מודד זמן, כותב ל־runLog ומחזיר תוצאה. |

---

## 2. סדר הזרימה – לפי שלבים

### שלב א׳ – אורח (ללא התחברות)

| מזהה | תיאור הבדיקה |
|------|----------------|
| **1.1** | דף בית נטען – כותרת, לוגו, CTA |
| **1.2** | ניווט: בית → אודות → תמחור → צור קשר |
| **1.3** | כפתור "התחל עכשיו" קיים |
| **1.4** | כפתור "התחברות" קיים |
| **1.6** | פוטר – קישורי מדיניות (Privacy, Terms) |
| **1.7** | גישה ישירה: `/LandingAbout`, `/LandingPrivacy`, `/LandingTerms` – ללא 404 |

---

### שלב ב׳ – אימות (Login / Logout)

| מזהה | תיאור הבדיקה |
|------|----------------|
| **2.1** | לחיצה על "התחברות" מפנה לדף Login |
| **2.2** | התחברות ב־PIN → מעבר ל־`/Dashboard` |
| **2.3** | התנתקות עובדת |

---

### שלב ג׳ – יצירת ישויות (Super Admin)

| מזהה | תיאור הבדיקה |
|------|----------------|
| **3.1** | יצירת **לקוח** חדש (מודל בדף People) |
| **4.1** | יצירת **פרויקט** חדש |
| **5.1** | יצירת **אירוע** בלוח שנה (תאריך, שעה) |
| **6.1** | יצירת **קבלן** (מודל People) |
| **6.2** | יצירת **יועץ** (מודל People) |
| **6.3** | יצירת **ספק** (מודל People) |

*הישויות נשמרות ב־`testData` ולא נמחקות – לבדיקה ידנית.*

---

### שלב ד׳ – ניווט ליבתי

| מזהה | תיאור הבדיקה |
|------|----------------|
| **7.1** | דף Recordings נטען |
| **7.2** | דף TimeTracking נטען |
| **7.3** | דף DesignLibrary נטען |
| **7.4** | דף Settings נטען |

---

### שלב ה׳ – הרשאות (RBAC)

| מזהה | תפקיד | תיאור הבדיקה |
|------|--------|----------------|
| **8.1** | Client | Dashboard נטען |
| **8.2** | Client | גישה מוגבלת ל־People (חסימה/הפניה) |
| **8.3** | Client | דף Projects נטען |
| **9.1** | Architect | Dashboard נטען |
| **9.2** | Architect | Projects נטען |
| **9.3** | Architect | Clients נטען |
| **9.4** | Architect | Calendar נטען |
| **10.1** | Consultant | Dashboard נטען |
| **10.2** | Consultant | Projects נטען |
| **11.1** | Contractor | Dashboard נטען |
| **11.2** | Contractor | Projects נטען |

---

### שלב ו׳ – דפים ציבוריים (ללא Login)

| מזהה | תיאור הבדיקה |
|------|----------------|
| **12** | גישה ל־PublicApproval, PublicContractorQuote, PublicMeetingBooking – נטען בלי התחברות |

---

### שלב ז׳ – Deep QA – לוח שנה

| מזהה | תיאור הבדיקה |
|------|----------------|
| **14.1** | צפייה בפרטי אירוע שנוצר |
| **14.2** | מעבר בין תצוגות לוח שנה (חודש / שבוע / יום) |
| **14.3** | כפתור אינטגרציה Google Calendar קיים |

---

### שלב ח׳ – Deep QA – מעקב זמן

| מזהה | תיאור הבדיקה |
|------|----------------|
| **15.1** | התחלת טיימר |
| **15.2** | ניווט בין דפים כ־61 שניות בזמן שטיימר רץ |
| **15.3** | עצירת טיימר אחרי 61+ שניות |
| **15.4** | דיווח שעות נוצר |
| **15.5** | מעבר בין טאבים ב־TimeTracking |

---

### שלב ט׳ – Deep QA – ניהול פרויקט (כל שלבי Workflow + תיק פרויקט)

| מזהה | תיאור הבדיקה |
|------|----------------|
| **16.1** | כניסה לפרויקט שנוצר (+ המתנה ל־networkidle ויציבות UI) |
| **16.2** | מעבר **בכל** שלבי Workflow: שיחה ראשונה, הצעת מחיר, יצירת גנט, מדידה, פרוגרמה וקונספט, סקיצות, הדמיות, היתרים, תוכניות עבודה, בחירות וכתב כמויות, ביצוע, סיום – לכל שלב: לחיצה, המתנה, וידוא טעינת תוכן |
| **16.3** | תיק פרויקט: פתיחת הקולפס "תיק פרויקט", מעבר בין **סקירה כללית**, **מסמכים**, **משימות** – המתנה ווידוא שהתוכן נראה (או "אין מסמכים"/"אין משימות") |
| **16.4** | פתיחת דיאלוג AI Report, המתנה לתגובת AI, סגירה |
| **16.5** | וידוא פונקציונליות בשלב הנוכחי – כפתור אופייני (הצעת מחיר, העלאה, הוסף וכו') או תוכן שלב |

---

### שלב י׳ – Deep QA – ספריית עיצוב

| מזהה | תיאור הבדיקה |
|------|----------------|
| **17.1** | כניסה לקטגוריה בספרייה |
| **17.2** | כפתור העלאה קיים |
| **17.3** | מעבר תצוגה Grid / List |
| **17.4** | חזרה לשורש ספריית התוכן |

---

### שלב י״א – Deep QA – לקוחות

| מזהה | תיאור הבדיקה |
|------|----------------|
| **18.1** | כניסה לפרופיל לקוח |
| **18.2** | Timeline לקוח קיים |
| **18.3** | כפתור עריכת לקוח קיים |

---

### שלב י״ב – Deep QA – Settings

| מזהה | תיאור הבדיקה |
|------|----------------|
| **19.1** | Dark Mode / מתג ערכת נושא עובד |
| **19.2** | בורר שפה (Language Selector) קיים |
| **19.3** | כפתור התנתקות קיים |

---

### שלב י״ג – Deep QA – Recordings

| מזהה | תיאור הבדיקה |
|------|----------------|
| **20.1** | דף Recordings נטען |
| **20.2** | כפתור הקלטה חדשה קיים |
| **20.3** | AI Features קיימים |

---

### שלב י״ד – Deep QA – הצעות מחיר

| מזהה | תיאור הבדיקה |
|------|----------------|
| **21.1** | גישה להצעות מחיר |
| **21.2** | יצירת הצעת מחיר |

---

### שלב ט״ו – Deep QA – Dashboard

| מזהה | תיאור הבדיקה |
|------|----------------|
| **22.1** | Dashboard Widgets נטענו |
| **22.2** | Quick Actions קיימים |
| **22.3** | רשימת אירועים/משימות קיימת |

---

### שלב ט״ז – בדיקות טכניות

| מזהה | תיאור הבדיקה |
|------|----------------|
| **23.1** | משתני סביבה (אימות עקיף – ההתחברות הצליחה) |
| **23.2** | רספונסיביות מובייל (Viewport 375×667) |
| **23.3** | RTL מוגדר (`dir="rtl"` או null) |
| **23.4** | אין שגיאות קריטיות בקונסול |

---

## 3. סיכום – מפת שלבים

| בלוק | טווח מזהה | תוכן |
|------|------------|------|
| **נחיתה** | 1.x | דף בית, ניווט, CTA, התחברות, פוטר, דפים פנימיים |
| **אימות** | 2.x | Login, Dashboard, Logout |
| **ישויות** | 3.1, 4.1, 5.1, 6.x | לקוח, פרויקט, אירוע, קבלן, יועץ, ספק |
| **ניווט** | 7.x | Recordings, TimeTracking, DesignLibrary, Settings |
| **RBAC** | 8–11 | Client, Architect, Consultant, Contractor |
| **ציבורי** | 12 | PublicApproval, PublicContractorQuote, PublicMeetingBooking |
| **לוח שנה** | 14.x | פרטי אירוע, תצוגות, Google Calendar |
| **מעקב זמן** | 15.x | טיימר, ניווט 61s, עצירה, דיווח, טאבים |
| **פרויקט** | 16.x | כניסה, כל שלבי Workflow (12), תיק פרויקט – סקירה/מסמכים/משימות, AI Report, וידוא פונקציונליות |
| **ספרייה** | 17.x | קטגוריה, העלאה, Grid/List, חזרה |
| **לקוחות** | 18.x | פרופיל, Timeline, עריכה |
| **Settings** | 19.x | Dark Mode, שפה, התנתקות |
| **Recordings** | 20.x | טעינה, כפתור הקלטה, AI |
| **הצעות מחיר** | 21.x | גישה, יצירה |
| **Dashboard** | 22.x | Widgets, Quick Actions, אירועים/משימות |
| **טכני** | 23.x | סביבה, רספונסיביות, RTL, קונסול |

---

## 4. למידה מריצה

- **סיכום לוג ריצה** – בסוף כל ריצה מודפס סיכום לפי `stepId`: מספר ok/fail/skip וסה"כ ms.
- **ייצוא** – עם `QA_RUN_LOG_FILE=playwright-qa-run.json` נשמר קובץ עם `runId`, `report`, `runLog` לניתוח לאחר מעשה.
- **שיפור** – לפי כשלונות ב־runLog (במיוחד 16.2–16.5) אפשר לחזק סלקטורים, להאריך timeouts או להוסיף `waitAfterAction` בנקודות קריטיות.

## 5. טיפול ובעיות מוכרות

| נושא | פעולה מומלצת |
|------|---------------|
| **Popup "הישאר מעודכן"** | לוודא `data-testid="notification-popup-later"` בדף; `dismissPopups()` נקרא אחרי טעינות רלוונטיות |
| **שגיאות קונסול/רשת** | Unauthorized / Failed to fetch – לטפל ב־API/הרשאות; לא חייבות להפיל טסט אך משפיעות על 23.4 |
| **סיום הטסט** | `expect(failed).toBe(0)` – כל שלב שכשל (❌) יגרום לכשלון הסוויט |
| **פרויקט לא נפתח (16.1)** | אם 16.1 נכשל, שלבים 16.2–16.5 מסומנים כנכשלים ודולגים ב־runLog |
| **Fail-fast** | כש־QA_FAIL_FAST פעיל (ברירת מחדל), כשל ראשון עוצר את הריצה ומדפיס את המזהה וההערה – לתקן ולהריץ מחדש עד 100%. |

---

**סימון:** ✅ עבר | ❌ נכשל | ⚠️ דולג
